<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Productivity Agent</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebaseConfig.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 0;
            stroke: currentColor;
            fill: currentColor;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        /* Modern gradient backgrounds */
        .bg-gradient-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bg-gradient-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
        }
        
        .bg-gradient-secondary {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
        }
        
        /* Glassmorphism effects */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Modern shadows */
        .shadow-modern {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        
        .shadow-modern-lg {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        /* Modern button styles */
        .btn-modern {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Modern input styles */
        .input-modern {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .input-modern:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #4f46e5;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }
        
        /* Modern card hover effects */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        /* Status indicators */
        .status-online {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }
        
        /* Modern scrollbar */
        .scrollbar-modern::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-modern::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .scrollbar-modern::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 3px;
        }
        
        .scrollbar-modern::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
        }
        
        /* Category badges */
        .badge-important {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .badge-newsletter {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .badge-spam {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }
        
        .badge-todo {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .badge-ai {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Simple SVG Icon Components
        const MailIcon = ({ className = "w-8 h-8" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
        );

        const SendIcon = ({ className = "w-5 h-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
        );

        const CheckIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const InboxIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
        );

        const ChatIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
        );

        const FileIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );

        const SettingsIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const EditIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
        );

        const SaveIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
            </svg>
        );

        const TrashIcon = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        // Mock Inbox Data
        const MOCK_INBOX = [
          {
            id: 1,
            sender: "john.doe@company.com",
            subject: "Q4 Budget Review Meeting",
            timestamp: "2024-11-20T09:30:00",
            body: "Hi team, I'd like to schedule a meeting next week to review the Q4 budget. Please let me know your availability for Tuesday or Wednesday afternoon. We need to finalize the numbers by Friday.",
            category: null,
            actionItems: []
          },
          {
            id: 2,
            sender: "newsletter@techcrunch.com",
            subject: "Daily Tech News - November 20",
            timestamp: "2024-11-20T08:00:00",
            body: "Your daily dose of tech news: AI breakthroughs, startup funding rounds, and the latest in tech policy. Click here to read more...",
            category: null,
            actionItems: []
          },
          {
            id: 3,
            sender: "urgent@client.com",
            subject: "URGENT: Production Server Down",
            timestamp: "2024-11-20T14:15:00",
            body: "Our production server is experiencing downtime. Please investigate immediately and provide an ETA for resolution. Our business operations are affected.",
            category: null,
            actionItems: []
          },
          {
            id: 4,
            sender: "hr@company.com",
            subject: "Action Required: Complete Annual Training by Nov 30",
            timestamp: "2024-11-19T10:00:00",
            body: "This is a reminder to complete your mandatory annual compliance training. The deadline is November 30th. Please log into the training portal and complete all modules.",
            category: null,
            actionItems: []
          },
          {
            id: 5,
            sender: "promotions@store.com",
            subject: "ðŸŽ‰ 50% OFF Everything - Limited Time!",
            timestamp: "2024-11-19T16:45:00",
            body: "Don't miss out! Get 50% off on all items. Shop now and save big. Offer expires soon. Click here to claim your discount!",
            category: null,
            actionItems: []
          },
          {
            id: 6,
            sender: "sarah.johnson@partner.com",
            subject: "Partnership Proposal Discussion",
            timestamp: "2024-11-18T11:20:00",
            body: "I'd love to discuss a potential partnership between our companies. Would you be available for a call this week? I believe we could create significant value together.",
            category: null,
            actionItems: []
          },
          {
            id: 7,
            sender: "project.updates@company.com",
            subject: "Project Alpha - Milestone 3 Completed",
            timestamp: "2024-11-18T15:30:00",
            body: "Great news! The development team has successfully completed Milestone 3 of Project Alpha. We're on track for the December launch. Next steps: QA testing and user acceptance.",
            category: null,
            actionItems: []
          },
          {
            id: 8,
            sender: "noreply@spam.biz",
            subject: "You've Won $1,000,000!!!",
            timestamp: "2024-11-17T22:10:00",
            body: "Congratulations! You are the lucky winner of our grand prize. Click here to claim your prize now. Act fast before it expires!",
            category: null,
            actionItems: []
          },
          {
            id: 9,
            sender: "lisa.chen@company.com",
            subject: "Code Review Request - Feature Branch",
            timestamp: "2024-11-17T13:45:00",
            body: "Hi, I've pushed my changes to the feature/user-authentication branch. Could you please review the code when you get a chance? I need approval before merging to main.",
            category: null,
            actionItems: []
          },
          {
            id: 10,
            sender: "events@conference.com",
            subject: "Tech Summit 2025 - Early Bird Registration",
            timestamp: "2024-11-16T09:00:00",
            body: "Register now for Tech Summit 2025! Early bird pricing ends December 1st. Join industry leaders for three days of innovation, networking, and learning.",
            category: null,
            actionItems: []
          }
        ];

        // Default Prompts
        const DEFAULT_PROMPTS = {
          categorization: `Categorize the following email into one of these categories: Important, Newsletter, Spam, To-Do.

Rules:
- Important: Urgent matters, critical updates, or time-sensitive information
- Newsletter: Marketing content, updates, promotional materials
- Spam: Suspicious offers, unwanted promotional content
- To-Do: Direct requests requiring user action

Return only the category name.`,
          
          actionItem: `Extract actionable tasks from the following email. 

Return a JSON array of tasks in this format:
[{"task": "description", "deadline": "date or null"}]

If no action items exist, return an empty array: []`,
          
          autoReply: `Generate a professional and polite email reply based on the following email.

Guidelines:
- If it's a meeting request, ask for an agenda
- If it's a task request, acknowledge and provide timeline
- Keep it concise and professional
- Match the tone of the original email

Return only the reply text without subject line.`
        };

        const EmailAgent = () => {
          const [emails, setEmails] = useState([]);
          const [selectedEmail, setSelectedEmail] = useState(null);
          const [activeTab, setActiveTab] = useState('inbox');
          const [prompts, setPrompts] = useState(DEFAULT_PROMPTS);
          const [editingPrompt, setEditingPrompt] = useState(null);
          const [chatMessages, setChatMessages] = useState([]);
          const [chatInput, setChatInput] = useState('');
          const [drafts, setDrafts] = useState([]);
          const [processing, setProcessing] = useState(false);
          const [aiProcessing, setAiProcessing] = useState(false);
          const [draftContent, setDraftContent] = useState({ subject: '', body: '' });
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(false);

          useEffect(() => {
            // Check auth state
            const checkAuth = () => {
              if (window.firebaseAuth) {
                window.firebaseAuth.onAuthStateChanged((user) => {
                  setUser(user);
                  setIsAuthenticated(!!user);
                  if (user) {
                    loadInbox();
                  } else {
                    setEmails([]);
                  }
                });
              }
            };
            
            checkAuth();
          }, []);

          // Gmail API integration
          const fetchGmailEmails = async () => {
            // Check for multiple token sources
            let accessToken = null;
            
            // Check localStorage first
            const storedToken = localStorage.getItem('gmail_access_token');
            if (storedToken) {
              accessToken = storedToken;
            }
            
            // Check Firebase token
            if (window.userToken && !accessToken) {
              accessToken = window.userToken;
            }
            
            if (!accessToken || !window.currentUser) {
              console.log('No Gmail token available, showing mock data');
              loadInbox();
              return;
            }

            setLoading(true);
            try {
              const response = await fetch('/api/gmail/fetch', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  idToken: accessToken,
                  maxResults: 20
                }),
              });

              if (response.ok) {
                const data = await response.json();
                const formattedEmails = data.emails.map(email => ({
                  ...email,
                  category: null,
                  actionItems: []
                }));
                setEmails(formattedEmails);
              } else {
                console.error('Failed to fetch emails, falling back to mock data');
                loadInbox();
              }
            } catch (error) {
              console.error('Error fetching Gmail:', error);
              console.log('Falling back to mock data');
              loadInbox();
            } finally {
              setLoading(false);
            }
          };

          const handleSignIn = async () => {
            try {
              setLoading(true);
              console.log('Attempting Google sign-in...');
              
              // Check if Firebase Auth is ready
              if (!window.firebaseAuth) {
                throw new Error('Firebase Auth not initialized yet');
              }
              
              await window.signInWithGoogle();
              console.log('Sign-in successful!');
              
            } catch (error) {
              console.error('Sign in failed:', error);
              
              // Show user-friendly error
              let errorMessage = 'Sign-in failed. ';
              
              if (error.message.includes('unauthorized-domain')) {
                errorMessage += 'Please contact support to add your domain to Firebase.';
              } else if (error.message.includes('popup')) {
                errorMessage += 'Please allow popups for this site and try again.';
              } else {
                errorMessage += error.message;
              }
              
              alert(errorMessage);
            } finally {
              setLoading(false);
            }
          };

          const handleSignOut = async () => {
            try {
              await window.signOutUser();
            } catch (error) {
              console.error('Sign out failed:', error);
            }
          };

          const loadInbox = () => {
            // If authenticated and we can fetch real Gmail, do that
            if (isAuthenticated && window.userToken) {
              fetchGmailEmails();
            } else {
              // Use mock data
              const loadedEmails = MOCK_INBOX.map(email => ({
                ...email,
                category: null,
                actionItems: []
              }));
              setEmails(loadedEmails);
            }
          };

          const processEmails = async (useAI = false) => {
            if (useAI) {
              setAiProcessing(true);
            } else {
              setProcessing(true);
            }
            
            try {
              if (useAI) {
                // AI-powered email analysis
                const processedEmails = [];
                
                for (const email of emails) {
                  try {
                    const response = await fetch('/api/ai/analyze-email', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({ email: email }),
                    });

                    if (response.ok) {
                      const data = await response.json();
                      const analysis = data.analysis;
                      
                      processedEmails.push({
                        ...email,
                        category: analysis.category,
                        priority: analysis.priority,
                        sentiment: analysis.sentiment,
                        summary: analysis.summary,
                        actionItems: analysis.actionItems || []
                      });
                    } else {
                      throw new Error('AI analysis failed');
                    }
                  } catch (error) {
                    console.warn(`AI analysis failed for email ${email.id}, using fallback:`, error);
                    // Fallback categorization
                    const fallbackEmail = getFallbackAnalysis(email);
                    processedEmails.push(fallbackEmail);
                  }
                }
                
                setTimeout(() => {
                  setEmails(processedEmails);
                  setAiProcessing(false);
                }, 1000);
              } else {
                // Original rule-based processing
                const processedEmails = emails.map(email => {
                  const fallbackEmail = getFallbackAnalysis(email);
                  return fallbackEmail;
                });
                
                setTimeout(() => {
                  setEmails(processedEmails);
                  setProcessing(false);
                }, 1500);
              }
            } catch (error) {
              console.error('Error processing emails:', error);
              setProcessing(false);
              setAiProcessing(false);
            }
          };

          const getFallbackAnalysis = (email) => {
            let category = 'Important';
            let actionItems = [];
            
            // Simple rule-based categorization
            if (email.subject.toLowerCase().includes('newsletter') || 
                email.sender.includes('newsletter') ||
                email.subject.includes('Daily')) {
              category = 'Newsletter';
            } else if (email.subject.toLowerCase().includes('won') || 
                       email.subject.includes('!!!') ||
                       email.subject.includes('50% OFF')) {
              category = 'Spam';
            } else if (email.body.toLowerCase().includes('please') || 
                       email.body.toLowerCase().includes('need to') ||
                       email.subject.toLowerCase().includes('action required')) {
              category = 'To-Do';
              
              // Extract action items for To-Do emails
              if (email.subject.includes('Code Review')) {
                actionItems = [{ task: 'Review code in feature/user-authentication branch', deadline: 'ASAP' }];
              } else if (email.subject.includes('Training')) {
                actionItems = [{ task: 'Complete annual compliance training', deadline: 'November 30' }];
              } else if (email.subject.includes('Meeting')) {
                actionItems = [{ task: 'Provide availability for Q4 budget meeting', deadline: 'This week' }];
              }
            } else if (email.subject.toLowerCase().includes('urgent')) {
              category = 'Important';
              actionItems = [{ task: 'Investigate production server downtime', deadline: 'Immediate' }];
            }
            
            return { 
              ...email, 
              category, 
              actionItems,
              priority: category === 'Important' ? 'high' : category === 'To-Do' ? 'medium' : 'low',
              sentiment: 'neutral',
              summary: email.body.substring(0, 100) + '...'
            };
          };

          const handleChatSubmit = async () => {
            if (!chatInput.trim()) return;
            
            const userMessage = { role: 'user', content: chatInput };
            setChatMessages([...chatMessages, userMessage]);
            setChatInput('');
            
            try {
              // Prepare context for AI
              const context = {
                selectedEmail: selectedEmail ? {
                  subject: selectedEmail.subject,
                  sender: selectedEmail.sender,
                  body: selectedEmail.body
                } : null,
                emails: emails,
                totalEmails: emails.length,
                categories: {
                  important: emails.filter(e => e.category === 'Important').length,
                  newsletter: emails.filter(e => e.category === 'Newsletter').length,
                  spam: emails.filter(e => e.category === 'Spam').length,
                  todo: emails.filter(e => e.category === 'To-Do').length
                },
                tasks: emails.flatMap(e => e.actionItems)
              };

              const response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  message: chatInput,
                  context: JSON.stringify(context)
                }),
              });

              if (response.ok) {
                const data = await response.json();
                const agentMessage = { role: 'agent', content: data.response };
                setChatMessages([...chatMessages, userMessage, agentMessage]);
                
                // Handle special actions
                const query = chatInput.toLowerCase();
                if (query.includes('draft') && selectedEmail) {
                  setTimeout(() => {
                    generateDraft(selectedEmail);
                  }, 1000);
                }
              } else {
                throw new Error('AI service unavailable');
              }
            } catch (error) {
              console.warn('AI service unavailable, using fallback responses:', error);
              
              // Fallback to original simple responses
              let response = '';
              const query = chatInput.toLowerCase();
              
              if (query.includes('summarize') && selectedEmail) {
                response = `Summary: ${selectedEmail.subject}\n\nFrom: ${selectedEmail.sender}\n\nKey points: ${selectedEmail.body.substring(0, 150)}...`;
              } else if (query.includes('urgent') || query.includes('important')) {
                const urgentEmails = emails.filter(e => e.category === 'Important');
                response = `You have ${urgentEmails.length} urgent emails:\n${urgentEmails.map(e => `- ${e.subject}`).join('\n')}`;
              } else if (query.includes('tasks') || query.includes('to-do')) {
                const allTasks = emails.flatMap(e => e.actionItems);
                response = allTasks.length > 0 
                  ? `Your tasks:\n${allTasks.map((t, i) => `${i + 1}. ${t.task} (${t.deadline})`).join('\n')}`
                  : 'No pending tasks found.';
              } else if (query.includes('draft') && selectedEmail) {
                response = `I've created a draft reply. Check the Drafts tab to review and edit it.`;
                generateDraft(selectedEmail);
              } else {
                response = "I can help you summarize emails, find urgent messages, list tasks, or draft replies. Try asking 'Show me urgent emails' or 'Draft a reply'.";
              }
              
              const agentMessage = { role: 'agent', content: response };
              setChatMessages([...chatMessages, userMessage, agentMessage]);
            }
          };

          const generateDraft = async (email, draftType = 'reply') => {
            try {
              const emailContent = `Subject: ${email.subject}\nFrom: ${email.sender}\nBody: ${email.body}`;
              
              const response = await fetch('/api/ai/generate-draft', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  emailContent: emailContent,
                  draftType: draftType
                }),
              });

              if (response.ok) {
                const data = await response.json();
                const newDraft = {
                  id: Date.now(),
                  originalEmailId: email.id,
                  subject: `Re: ${email.subject}`,
                  body: data.draft,
                  createdAt: new Date().toISOString(),
                  aiGenerated: true
                };
                
                setDrafts([...drafts, newDraft]);
                return newDraft;
              } else {
                throw new Error('AI service unavailable');
              }
            } catch (error) {
              console.warn('AI draft generation failed, using fallback:', error);
              
              // Fallback to original draft generation
              let draftBody = '';
              
              if (email.subject.toLowerCase().includes('meeting')) {
                draftBody = `Hi ${email.sender.split('@')[0]},\n\nThank you for reaching out. I'd be happy to join the meeting.\n\nCould you please share an agenda beforehand so I can prepare accordingly? I'm available on both Tuesday and Wednesday afternoons.\n\nLooking forward to the discussion.\n\nBest regards`;
              } else if (email.subject.toLowerCase().includes('code review')) {
                draftBody = `Hi ${email.sender.split('@')[0]},\n\nI'll review your code changes today and provide feedback by end of day.\n\nThanks for the heads up!\n\nBest`;
              } else if (email.subject.toLowerCase().includes('urgent')) {
                draftBody = `Hi ${email.sender.split('@')[0]},\n\nI've received your urgent message and am investigating the issue immediately. I'll provide an update within the next hour with an ETA for resolution.\n\nThank you for bringing this to our attention.\n\nBest regards`;
              } else {
                draftBody = `Hi ${email.sender.split('@')[0]},\n\nThank you for your email regarding "${email.subject}".\n\n[Your response here]\n\nBest regards`;
              }
              
              const newDraft = {
                id: Date.now(),
                originalEmailId: email.id,
                subject: `Re: ${email.subject}`,
                body: draftBody,
                createdAt: new Date().toISOString(),
                aiGenerated: false
              };
              
              setDrafts([...drafts, newDraft]);
              return newDraft;
            }
          };

          const saveDraft = () => {
            if (!draftContent.subject || !draftContent.body) return;
            
            const newDraft = {
              id: Date.now(),
              originalEmailId: selectedEmail?.id || null,
              subject: draftContent.subject,
              body: draftContent.body,
              createdAt: new Date().toISOString()
            };
            
            setDrafts([...drafts, newDraft]);
            setDraftContent({ subject: '', body: '' });
          };

          const getCategoryColor = (category) => {
            const colors = {
              'Important': 'badge-important',
              'Newsletter': 'badge-newsletter',
              'Spam': 'badge-spam',
              'To-Do': 'badge-todo'
            };
            return colors[category] || 'badge-spam';
          };

          return (
            <div className="min-h-screen">
              {/* Header */}
              <div className="glass shadow-modern border-b border-white/20 px-8 py-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="p-3 bg-gradient-primary rounded-2xl shadow-modern">
                      <MailIcon className="w-8 h-8 text-white" />
                    </div>
                    <div>
                      <h1 className="text-3xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent">
                        Email Productivity Agent
                      </h1>
                      <p className="text-sm text-slate-500 mt-1">Powered by Advanced AI</p>
                    </div>
                  </div>
                  <div className="flex items-center space-x-6">
                    {isAuthenticated ? (
                      <div className="flex items-center space-x-4">
                        <div className="flex items-center space-x-3">
                          <div className="w-10 h-10 bg-gradient-to-r from-emerald-400 to-cyan-400 rounded-full flex items-center justify-center">
                            <span className="text-white font-semibold text-sm">
                              {(user?.displayName || user?.email)?.charAt(0).toUpperCase()}
                            </span>
                          </div>
                          <div>
                            <p className="text-sm font-medium text-slate-700">
                              Welcome back
                            </p>
                            <p className="text-xs text-slate-500">
                              {user?.displayName || user?.email}
                            </p>
                          </div>
                        </div>
                        <button
                          onClick={handleSignOut}
                          className="btn-modern px-6 py-3 bg-gradient-to-r from-red-500 to-pink-500 text-white font-medium rounded-xl shadow-modern disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          Sign Out
                        </button>
                      </div>
                    ) : (
                      <button
                        onClick={handleSignIn}
                        className="btn-modern px-6 py-3 bg-gradient-to-r from-emerald-500 to-cyan-500 text-white font-medium rounded-xl shadow-modern"
                      >
                        Sign In with Google
                      </button>
                    )}
                    <div className="flex space-x-3">
                      <button
                        onClick={() => processEmails(false)}
                        disabled={processing || aiProcessing}
                        className="btn-modern flex items-center space-x-2 px-6 py-3 bg-white/20 backdrop-blur-md text-slate-700 font-medium rounded-xl shadow-modern border border-white/30 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-white/30"
                      >
                        <CheckIcon className="w-4 h-4" />
                        <span>{processing ? 'Processing...' : 'Process'}</span>
                      </button>
                      <button
                        onClick={() => processEmails(true)}
                        disabled={processing || aiProcessing}
                        className="btn-modern flex items-center space-x-2 px-6 py-3 btn-gradient text-white font-medium rounded-xl shadow-modern disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        <span className="text-lg">ðŸ¤–</span>
                        <span>{aiProcessing ? 'AI Processing...' : 'AI Process'}</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              {/* Navigation Tabs */}
              <div className="glass border-b border-white/20">
                <div className="flex space-x-1 px-8">
                  {[
                    { id: 'inbox', icon: InboxIcon, label: 'Inbox' },
                    { id: 'agent', icon: ChatIcon, label: 'Agent' },
                    { id: 'drafts', icon: FileIcon, label: 'Drafts' },
                    { id: 'prompts', icon: SettingsIcon, label: 'Prompts' }
                  ].map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`relative px-6 py-4 font-semibold capitalize flex items-center space-x-3 transition-all duration-300 ${
                        activeTab === tab.id
                          ? 'text-indigo-600'
                          : 'text-slate-600 hover:text-slate-800 hover:bg-white/10'
                      }`}
                    >
                      <tab.icon className={`w-5 h-5 ${activeTab === tab.id ? 'text-indigo-600' : 'text-slate-500'}`} />
                      <span className="text-sm">{tab.label}</span>
                      {activeTab === tab.id && (
                        <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-full"></div>
                      )}
                    </button>
                  ))}
                </div>
              </div>

              {/* Main Content */}
              <div className="p-8">
                {/* Inbox View */}
                {activeTab === 'inbox' && (
                  <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div className="glass rounded-2xl shadow-modern border border-white/20 overflow-hidden">
                      <div className="p-6 border-b border-white/10">
                        <div className="flex items-center justify-between">
                          <h2 className="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent">
                            Inbox
                          </h2>
                          <span className="px-3 py-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white text-sm font-medium rounded-full">
                            {emails.length} emails
                          </span>
                        </div>
                      </div>
                      <div className="divide-y divide-white/10 max-h-[650px] overflow-y-auto scrollbar-modern">
                        {emails.map(email => (
                          <div
                            key={email.id}
                            onClick={() => setSelectedEmail(email)}
                            className={`card-hover p-6 cursor-pointer transition-all duration-300 ${
                              selectedEmail?.id === email.id 
                                ? 'bg-gradient-to-r from-indigo-50/50 to-purple-50/50 border-l-4 border-indigo-500' 
                                : 'hover:bg-white/20'
                            }`}
                          >
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex-1">
                                <div className="flex items-center space-x-3 mb-2">
                                  <div className="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center">
                                    <span className="text-white text-xs font-semibold">
                                      {email.sender.charAt(0).toUpperCase()}
                                    </span>
                                  </div>
                                  <span className="font-semibold text-slate-800 text-sm">
                                    {email.sender}
                                  </span>
                                  {email.category && (
                                    <span className={`px-3 py-1 rounded-full text-xs font-semibold text-white ${getCategoryColor(email.category)}`}>
                                      {email.category}
                                    </span>
                                  )}
                                </div>
                                <h3 className="font-semibold text-slate-900 mb-2 leading-tight">
                                  {email.subject}
                                </h3>
                                <div className="flex items-center space-x-2 text-xs text-slate-500">
                                  <span>{new Date(email.timestamp).toLocaleDateString()}</span>
                                  <span>â€¢</span>
                                  <span>{new Date(email.timestamp).toLocaleTimeString()}</span>
                                </div>
                                {email.actionItems.length > 0 && (
                                  <div className="mt-3 space-y-2">
                                    {email.actionItems.map((item, idx) => (
                                      <div key={idx} className="flex items-start text-sm">
                                        <div className="w-2 h-2 bg-emerald-400 rounded-full mt-2 mr-2 flex-shrink-0"></div>
                                        <span className="text-emerald-700 bg-emerald-50 px-2 py-1 rounded-lg">
                                          {item.task}
                                        </span>
                                      </div>
                                    ))}
                                  </div>
                                )}
                                
                                {/* AI-generated metadata */}
                                {(email.priority || email.sentiment || email.summary) && (
                                  <div className="mt-3 flex flex-wrap gap-2">
                                    {email.priority && (
                                      <span className={`px-3 py-1 rounded-full text-xs font-medium text-white ${
                                        email.priority === 'high' ? 'bg-gradient-to-r from-red-500 to-pink-500' :
                                        email.priority === 'medium' ? 'bg-gradient-to-r from-yellow-500 to-orange-500' :
                                        'bg-gradient-to-r from-green-500 to-emerald-500'
                                      }`}>
                                        {email.priority}
                                      </span>
                                    )}
                                    {email.sentiment && (
                                      <span className="px-3 py-1 bg-gradient-to-r from-slate-500 to-slate-600 text-white rounded-full text-xs font-medium">
                                        {email.sentiment}
                                      </span>
                                    )}
                                    <span className="px-3 py-1 badge-ai text-white rounded-full text-xs font-medium flex items-center space-x-1">
                                      <span>ðŸ¤–</span>
                                      <span>AI</span>
                                    </span>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div className="glass rounded-2xl shadow-modern border border-white/20 overflow-hidden">
                      {selectedEmail ? (
                        <div className="p-8">
                          <div className="mb-6">
                            <div className="flex items-start justify-between mb-4">
                              <h3 className="text-2xl font-bold text-slate-900 leading-tight pr-4">
                                {selectedEmail.subject}
                              </h3>
                              {selectedEmail.category && (
                                <span className={`px-4 py-2 rounded-full text-sm font-bold text-white ${getCategoryColor(selectedEmail.category)}`}>
                                  {selectedEmail.category}
                                </span>
                              )}
                            </div>
                            <div className="space-y-3">
                              <div className="flex items-center space-x-3">
                                <div className="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center">
                                  <span className="text-white font-semibold text-sm">
                                    {selectedEmail.sender.charAt(0).toUpperCase()}
                                  </span>
                                </div>
                                <div>
                                  <p className="font-semibold text-slate-800 text-sm">
                                    {selectedEmail.sender}
                                  </p>
                                  <p className="text-sm text-slate-500">
                                    {new Date(selectedEmail.timestamp).toLocaleDateString()} at {new Date(selectedEmail.timestamp).toLocaleTimeString()}
                                  </p>
                                </div>
                              </div>
                              
                              {/* AI-generated metadata */}
                              {(selectedEmail.priority || selectedEmail.sentiment) && (
                                <div className="flex flex-wrap gap-3 pt-2">
                                  {selectedEmail.priority && (
                                    <div className="flex items-center space-x-2">
                                      <span className="text-sm font-medium text-slate-600">Priority:</span>
                                      <span className={`px-3 py-1 rounded-full text-sm font-bold text-white ${
                                        selectedEmail.priority === 'high' ? 'bg-gradient-to-r from-red-500 to-pink-500' :
                                        selectedEmail.priority === 'medium' ? 'bg-gradient-to-r from-yellow-500 to-orange-500' :
                                        'bg-gradient-to-r from-green-500 to-emerald-500'
                                      }`}>
                                        {selectedEmail.priority}
                                      </span>
                                    </div>
                                  )}
                                  {selectedEmail.sentiment && (
                                    <div className="flex items-center space-x-2">
                                      <span className="text-sm font-medium text-slate-600">Sentiment:</span>
                                      <span className="px-3 py-1 bg-gradient-to-r from-slate-500 to-slate-600 text-white rounded-full text-sm font-medium">
                                        {selectedEmail.sentiment}
                                      </span>
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                          
                          <div className="border-t border-white/20 pt-6">
                            {selectedEmail.summary && (
                              <div className="mb-6 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200/50 rounded-2xl">
                                <h4 className="font-bold text-purple-800 mb-2 flex items-center">
                                  <span className="mr-2 text-lg">ðŸ¤–</span>
                                  AI Summary
                                </h4>
                                <p className="text-purple-700 text-sm leading-relaxed">{selectedEmail.summary}</p>
                              </div>
                            )}
                            <div className="prose prose-slate max-w-none">
                              <p className="text-slate-700 whitespace-pre-wrap leading-relaxed">{selectedEmail.body}</p>
                            </div>
                          </div>
                          
                          {selectedEmail.actionItems.length > 0 && (
                            <div className="mt-8 border-t border-white/20 pt-6">
                              <h4 className="font-bold text-slate-800 mb-4 flex items-center">
                                <span className="mr-2">âœ…</span>
                                Action Items
                              </h4>
                              <ul className="space-y-3">
                                {selectedEmail.actionItems.map((item, idx) => (
                                  <li key={idx} className="flex items-start bg-white/50 rounded-xl p-4 border border-white/30">
                                    <CheckIcon className="w-5 h-5 mr-3 mt-0.5 text-emerald-500 flex-shrink-0" />
                                    <div>
                                      <p className="font-semibold text-slate-800">{item.task}</p>
                                      <p className="text-sm text-slate-500 mt-1">Deadline: {item.deadline}</p>
                                    </div>
                                  </li>
                                ))}
                              </ul>
                            </div>
                          )}
                          
                          <div className="mt-8 space-y-4">
                            <button
                              onClick={async () => {
                                await generateDraft(selectedEmail);
                                setActiveTab('drafts');
                              }}
                              className="w-full btn-modern py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold rounded-xl shadow-modern flex items-center justify-center space-x-2"
                            >
                              <span className="text-lg">ðŸ¤–</span>
                              <span>AI Generate Draft Reply</span>
                            </button>
                            <button
                              onClick={async () => {
                                await generateDraft(selectedEmail, 'followup');
                                setActiveTab('drafts');
                              }}
                              className="w-full btn-modern py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-xl shadow-modern flex items-center justify-center space-x-2"
                            >
                              <span className="text-lg">ðŸ“§</span>
                              <span>AI Generate Follow-up</span>
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="p-12 text-center">
                          <div className="w-20 h-20 bg-gradient-to-r from-slate-200 to-slate-300 rounded-2xl flex items-center justify-center mx-auto mb-6">
                            <InboxIcon className="w-10 h-10 text-slate-400" />
                          </div>
                          <p className="text-slate-500 font-medium">Select an email to view details</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Agent Chat View */}
                {activeTab === 'agent' && (
                  <div className="max-w-5xl mx-auto">
                    <div className="glass rounded-2xl shadow-modern border border-white/20 overflow-hidden">
                      <div className="p-8 border-b border-white/10">
                        <div className="flex items-center justify-between">
                          <div>
                            <h2 className="text-2xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent mb-2">
                              AI Email Agent
                            </h2>
                            <p className="text-slate-600 text-sm leading-relaxed">
                              Ask me to summarize emails, find urgent messages, list tasks, or draft replies
                            </p>
                            <div className="flex items-center mt-3 space-x-2">
                              <span className="text-lg">ðŸ¤–</span>
                              <p className="text-xs text-purple-600 font-medium">
                                Enhanced with Google Gemini AI for smarter responses
                              </p>
                            </div>
                          </div>
                          <div className="text-right">
                            <div className="flex items-center space-x-3">
                              <div className="flex items-center space-x-2">
                                <div className="status-online w-3 h-3 rounded-full animate-pulse"></div>
                                <span className="text-sm text-slate-600 font-medium">AI Active</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div className="h-[600px] overflow-y-auto p-8 space-y-6 scrollbar-modern">
                        {chatMessages.length === 0 ? (
                          <div className="text-center text-slate-500 mt-20">
                            <div className="w-20 h-20 bg-gradient-to-r from-indigo-400 to-purple-400 rounded-2xl flex items-center justify-center mx-auto mb-6">
                              <ChatIcon className="w-10 h-10 text-white" />
                            </div>
                            <p className="text-lg mb-2 font-medium">Start a conversation with the Email Agent</p>
                            <div className="mt-6 text-sm space-y-3">
                              <p className="font-semibold text-slate-600">Try asking:</p>
                              <div className="space-y-2">
                                <p className="text-indigo-600 bg-indigo-50 px-4 py-2 rounded-lg inline-block">"Show me all urgent emails"</p><br/>
                                <p className="text-purple-600 bg-purple-50 px-4 py-2 rounded-lg inline-block">"What tasks do I need to do?"</p><br/>
                                <p className="text-pink-600 bg-pink-50 px-4 py-2 rounded-lg inline-block">"Summarize this email"</p>
                              </div>
                            </div>
                          </div>
                        ) : (
                          chatMessages.map((msg, idx) => (
                            <div
                              key={idx}
                              className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                            >
                              <div
                                className={`max-w-[75%] rounded-2xl px-6 py-4 ${
                                  msg.role === 'user'
                                    ? 'btn-gradient text-white shadow-modern'
                                    : 'bg-white/50 backdrop-blur-sm text-slate-800 border border-white/30'
                                }`}
                              >
                                {msg.role === 'agent' && (
                                  <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center space-x-2 text-xs opacity-75">
                                      <span className="text-lg">ðŸ¤–</span>
                                      <span className="font-medium">AI Assistant</span>
                                    </div>
                                    <div className="status-online w-2 h-2 rounded-full"></div>
                                  </div>
                                )}
                                <p className="whitespace-pre-wrap leading-relaxed">{msg.content}</p>
                              </div>
                            </div>
                          ))
                        )}
                      </div>
                      <div className="p-8 border-t border-white/10">
                        <div className="flex space-x-4">
                          <input
                            type="text"
                            value={chatInput}
                            onChange={(e) => setChatInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleChatSubmit()}
                            placeholder="Ask the agent anything about your emails..."
                            className="input-modern flex-1 border-0 bg-white/50 backdrop-blur-sm rounded-xl px-6 py-4 focus:outline-none focus:ring-4 focus:ring-indigo-500/20 placeholder-slate-500"
                          />
                          <button
                            onClick={handleChatSubmit}
                            disabled={!chatInput.trim()}
                            className="btn-modern px-8 py-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium rounded-xl shadow-modern disabled:opacity-50 disabled:cursor-not-allowed hover:from-indigo-600 hover:to-purple-600"
                          >
                            <SendIcon className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Drafts View */}
                {activeTab === 'drafts' && (
                  <div className="max-w-5xl mx-auto space-y-8">
                    <div className="glass rounded-2xl shadow-modern border border-white/20 p-8">
                      <h2 className="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent mb-6">
                        Create New Draft
                      </h2>
                      <div className="space-y-6">
                        <input
                          type="text"
                          placeholder="Subject"
                          value={draftContent.subject}
                          onChange={(e) => setDraftContent({ ...draftContent, subject: e.target.value })}
                          className="input-modern w-full rounded-xl px-6 py-4 border-0 bg-white/50 backdrop-blur-sm focus:outline-none focus:ring-4 focus:ring-indigo-500/20 placeholder-slate-500"
                        />
                        <textarea
                          placeholder="Email body..."
                          value={draftContent.body}
                          onChange={(e) => setDraftContent({ ...draftContent, body: e.target.value })}
                          rows={10}
                          className="input-modern w-full rounded-xl px-6 py-4 border-0 bg-white/50 backdrop-blur-sm focus:outline-none focus:ring-4 focus:ring-indigo-500/20 placeholder-slate-500"
                        />
                        <button
                          onClick={saveDraft}
                          disabled={!draftContent.subject || !draftContent.body}
                          className="btn-modern flex items-center space-x-3 px-8 py-4 bg-gradient-to-r from-emerald-500 to-cyan-500 text-white font-medium rounded-xl shadow-modern disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          <SaveIcon className="w-5 h-5" />
                          <span>Save Draft</span>
                        </button>
                      </div>
                    </div>

                    <div className="glass rounded-2xl shadow-modern border border-white/20 overflow-hidden">
                      <div className="p-6 border-b border-white/10">
                        <div className="flex items-center justify-between">
                          <h2 className="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent">
                            Saved Drafts
                          </h2>
                          <span className="px-4 py-2 bg-gradient-to-r from-slate-500 to-slate-600 text-white text-sm font-medium rounded-full">
                            {drafts.length} drafts
                          </span>
                        </div>
                      </div>
                      <div className="divide-y divide-white/10 max-h-[600px] overflow-y-auto scrollbar-modern">
                        {drafts.length === 0 ? (
                          <div className="p-12 text-center">
                            <div className="w-20 h-20 bg-gradient-to-r from-slate-200 to-slate-300 rounded-2xl flex items-center justify-center mx-auto mb-6">
                              <FileIcon className="w-10 h-10 text-slate-400" />
                            </div>
                            <p className="text-slate-500 font-medium">No drafts yet. Generate replies or create new drafts above.</p>
                          </div>
                        ) : (
                          drafts.map(draft => (
                            <div key={draft.id} className="p-6 card-hover">
                              <div className="flex items-start justify-between mb-4">
                                <div className="flex items-center space-x-3">
                                  <h3 className="font-bold text-slate-900">{draft.subject}</h3>
                                  {draft.aiGenerated && (
                                    <span className="px-3 py-1 badge-ai text-white text-xs rounded-full flex items-center space-x-1">
                                      <span>ðŸ¤–</span>
                                      <span>AI Generated</span>
                                    </span>
                                  )}
                                </div>
                                <button
                                  onClick={() => setDrafts(drafts.filter(d => d.id !== draft.id))}
                                  className="text-red-500 hover:text-red-700 transition-colors p-2 hover:bg-red-50 rounded-lg"
                                >
                                  <TrashIcon className="w-4 h-4" />
                                </button>
                              </div>
                              <p className="text-sm text-slate-500 mb-4">
                                {new Date(draft.createdAt).toLocaleDateString()} at {new Date(draft.createdAt).toLocaleTimeString()}
                                {draft.aiGenerated && (
                                  <span className="ml-2 text-purple-600 font-medium">
                                    â€¢ Enhanced by AI
                                  </span>
                                )}
                              </p>
                              <p className="text-slate-700 whitespace-pre-wrap leading-relaxed bg-slate-50/50 p-4 rounded-xl border border-slate-200/50">
                                {draft.body}
                              </p>
                            </div>
                          ))
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {/* Prompts Configuration */}
                {activeTab === 'prompts' && (
                  <div className="max-w-5xl mx-auto space-y-8">
                    {Object.entries(prompts).map(([key, value]) => (
                      <div key={key} className="glass rounded-2xl shadow-modern border border-white/20 p-8">
                        <div className="flex items-center justify-between mb-6">
                          <h3 className="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent capitalize">
                            {key.replace(/([A-Z])/g, ' $1').trim()} Prompt
                          </h3>
                          <button
                            onClick={() => setEditingPrompt(editingPrompt === key ? null : key)}
                            className="btn-modern flex items-center space-x-2 px-6 py-3 text-indigo-600 hover:text-indigo-800 bg-indigo-50 hover:bg-indigo-100 rounded-xl font-medium transition-all"
                          >
                            <EditIcon className="w-4 h-4" />
                            <span>{editingPrompt === key ? 'Cancel' : 'Edit'}</span>
                          </button>
                        </div>
                        {editingPrompt === key ? (
                          <div className="space-y-4">
                            <textarea
                              value={value}
                              onChange={(e) => setPrompts({ ...prompts, [key]: e.target.value })}
                              rows={10}
                              className="input-modern w-full rounded-xl px-6 py-4 border-0 bg-white/50 backdrop-blur-sm focus:outline-none focus:ring-4 focus:ring-indigo-500/20 font-mono text-sm"
                            />
                            <button
                              onClick={() => setEditingPrompt(null)}
                              className="btn-modern flex items-center space-x-2 px-8 py-4 bg-gradient-to-r from-emerald-500 to-cyan-500 text-white font-medium rounded-xl shadow-modern"
                            >
                              <SaveIcon className="w-4 h-4" />
                              <span>Save Prompt</span>
                            </button>
                          </div>
                        ) : (
                          <pre className="bg-slate-50/50 p-6 rounded-xl text-sm whitespace-pre-wrap font-mono text-slate-700 border border-slate-200/50">
                            {value}
                          </pre>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          );
        };

        // Render the component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EmailAgent />);
    </script>
</body>
</html>
